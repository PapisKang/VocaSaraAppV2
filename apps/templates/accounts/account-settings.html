{% extends 'layouts/base.html' %}

{% block title %} Settings {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block body_class %} g-sidenav-show bg-gray-100 {% endblock %}

{% block content %}

<<<<<<< HEAD
 {%include 'home/index.html'%}
=======

>>>>>>> Prince-Gildas
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-eF8CFv0h+oCd4fMXM7XYqqF2+rWLGIEvHkPFt8+gFSpVvgdWgaW0GniPkziF+0jf" crossorigin="anonymous">
<style>
  h5{ 
    color: cornflowerblue;
    font-family:math;
  }
</style>
<div class="container-fluid my-3 py-3">

  
    <div class="col-lg-3">
      
    </div>
    <div class="col-lg-9 mt-lg-0 mt-4">
      <!-- Card Profile -->
      <div class="card card-body" id="profile">
        <div class="row justify-content-center align-items-center">
          <div class="col-sm-auto col-4">
            <div >
              <img class="" id=""
            </div>
              <div class="certificated-badge">
                <div class="new_Btn img-choose-icon">
                  <i class="" style=""></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-sm-auto col-8 my-auto">
            <div class="h-100">
              <h5 class="mb-1 font-weight-bolder">
                {{current_user.username}}
              </h5>
              <p class="mb-0 font-weight-bold text-sm">
                {{ context['profile_bio']}}
              </p>
            </div>
          </div>
          <div class="col-sm-auto ms-sm-auto mt-sm-0 mt-3 d-flex">
          </div>
        </div>
      </div>
      <!-- Card Basic Info -->
      <div class="card mt-4" id="basic-info">
        <div class="card-header">
          <h5><i class="fas fa-edit"></i> Compléter vos informations</h5>
        </div>
        <div class="card-body pt-0">
          <form method="put" id="userEditForm" enctype="multipart/form-data">
            <input type="hidden" id="user_id" value="{{current_user.id}}" name="user_id">
            <input id="imageid-btn" type='file' name="image" accept="image/*" onchange="loadFile(event)" />
            <div class="card">
              <div class="card-body">
                <!-- <h5 class="mt-5 mb-3">Basic Info</h5> -->
                <!-- Email verifications -->
                {% if not current_user.email %}
                <div class="alert alert-danger alert-dismissible" role="alert">
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"> </button>
                  <h5 class="alert-heading"><i class="feather icon-alert-circle me-2"></i> Verification de l'adresse
                    email</h5>
                  <p class="mb-0"> Ajouter votre email s'il vous plait. </p>
                </div>
                {% endif %}
                <!-- End email verification -->
                <div class="row mt-2">
                  <div class="col-sm-6">
                    <label class="form-label"> <i class='bx bx-rename bx-flashing bx-flip-vertical ' ></i> Nom Complet</label>
                    <input type="text" id="full_name" name="full_name" class="form-control" placeholder="Nom Complet"
                      value="{{context['profile_name']}}">
                  </div>
  
              <div class="col-sm-6">
                <label class="form-label"> <i class='bx bxs-face bx-flashing' ></i> Bio</label>
                <input type="text" id="bio" name="bio" class="form-control" placeholder="Bio"
                  value="{{ context['profile_bio']}}">
              </div>
                <div class="row mt-2">
                  <div class="col-sm-6">
                    <label class="form-label"><i class='bx bx-envelope bx-flashing bx-flip-vertical' ></i> Email</label>
                    <input type="email" id="email" name="email" {% if current_user.email %} readonly
                      value="{{ current_user.email }}" {% else %} placeholder="Email" {% endif %} class="form-control">
                    <section class="display-error-message">
                    </section>
                  </div>
                  <div class="col-sm-6">
                    <label class="form-label"> <i class='bx bx-phone-call bx-flashing bx-flip-vertical' ></i> Téléphone</label>
                    <input type="text" id="phone" name="phone" class="form-control" placeholder="Téléphone"
                      value="{{ context['profile_phone']}}">
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-sm-6">
                    <label class="form-label"> <i class='bx bxs-component bx-flashing bx-flip-vertical' ></i> Service</label>
                    <input type="text" id="service" name="service" class="form-control" placeholder="Service"
                      value="{{ context['profile_service'] }}">
                  </div>
                  <div class="col-sm-6">
                    <label class="form-label"><i class='bx bxl-codepen bx-flashing bx-flip-vertical' ></i> Code Postal</label>
                    <input type="text" id="zipcode" name="zipcode" class="form-control" placeholder="Code Postal"
                      value="{{ context['profile_zipcode']}}">
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-sm-12">
                    <label class="form-label"> <i class='bx bxs-user-detail bx-flashing' ></i> Adresse</label>
                    <input type="text" id="Adresse" name="address" class="form-control"
                      value="{{ context['profile_address']}}">
                  </div>
                </div>
              </div>
                <br>
                <button type="button" class="btn btn-primary" onclick="updateUserInfo()"> <i class="fas fa-save"></i> Sauvegarder Informations</button>
              </div>
            </div>
          </form>
        </div>
      </div>
      <!-- Card Change Password -->
      </div>
<!-- Card Change Password -->
{% if current_user.email %}
<div class="card mt-4" id="password">
  <div class="card-header">
    <h5><i class="fas fa-key"></i> Changer de mot de passe</h5>
  </div>
  <div class="card-body pt-0">

    <!-- Change password -->
    <div class="row">
      <div class="col-lg-12">

        <!-- Change Password -->
        <div id="changePassForm">
          <div class="card-body pt-0">
            <form action="" method="post">

              <!-- Nouveau mot de passe -->
              <div class="form-group">
                <label class="form-label"><i class='bx bx-sort-a-z bx-flashing' ></i> Nouveau mot de passe</label>
                <div class="input-group">
                  <input class="form-control" id="id_password1" name="new_password" type="password" placeholder="Nouveau mot de passe" required>
                  <button type="button" class="btn btn-outline-secondary password-toggle-btn" onclick="togglePassword('id_password1')">
                    <i class="far fa-eye"></i>
                  </button>
                </div>
              </div>

              <!-- Confirmer le nouveau mot de passe -->
              <div class="form-group">
                <label class="form-label"><i class='bx bx-check-double bx-flashing' ></i> Confirmer le nouveau mot de passe</label>
                <div class="input-group">
                  <input class="form-control" id="id_password2" name="new_password2" type="password" placeholder="Confirmer le nouveau mot de passe" required>
                  <button type="button" class="btn btn-outline-secondary password-toggle-btn" onclick="togglePassword('id_password2')">
                    <i class="far fa-eye"></i>
                  </button>
                </div>
              </div>
              <h5 class="mt-5"><i class="fas fa-exclamation-triangle"></i>Exigences du mot de passe</h5>
              <ul class="text-muted ps-4 mb-0 float-start" >
                <li  >
                  <i class="fas fa-check"></i> Doit contenir au moins 8 caractères.<br>
                  <i class="fas fa-check"></i> Doit contenir au moins une lettre majuscule.<br>
                  <i class="fas fa-check"></i> Doit contenir au moins un chiffre.<br>
                  <i class="fas fa-check"></i> Doit contenir au moins un caractère spécial.
          
                </li>
              </ul>
              <button type="button" class="btn btn-primary shadow-2 mb-4 bg-gradient-dark btn-sm float-end mt-6 mb-0" onclick="changePassword()"><i class="fas fa-lock fa-2x"></i> Modifier le mot de passe</button>
            </div>
          </form>
        </div>

      </div>
    </div>

  </div>
</div>
{% endif %}

</div>

{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}

<script src="{{ config.ASSETS_ROOT }}/js/plugins/choices.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
// Fonction pour mettre à jour les informations de l'utilisateur
function updateUserInfo() {
  var formData = new FormData($("#userEditForm")[0]);
  var files = $('#imageid-btn')[0].files;
  // Check file selected or not
  if (files.length > 0) {
    formData.append('imageid-btn', files[0]);
  }

  $.ajax({
    type: 'PUT',
    url: "{{ url_for('authentication_blueprint.edit_user') }}",
    data: formData,
    async: false,
    cache: false,
    contentType: false,
    processData: false,
    success: function(response) {
      console.log(response);
      if (response.success) {
        alert('Informations mise à jour');
        location.reload();
      } else {
        alert('success: ' + response.message);
      }
    },
    error: function(xhr, status, error) {
      console.error(xhr.responseText);
      alert('Aucune informations');
    }
  });
}

// change password
function changePassword() {
  var new_password = document.getElementById('id_password1').value;
  var new_password2 = document.getElementById('id_password2').value;

  // Faire une requête Ajax pour changer le mot de passe
  $.ajax({
    type: 'POST',
    url: '/change_password',
    data: {
      new_password: new_password,
      new_password2: new_password2
    },
    success: function(response) {
      console.log(response);  // Affiche la réponse dans la console
      if (response.success) {
        Toastify({
          text: response.message,
          duration: 3000,
          close: true,
          gravity: 'bottom', // Position du message (top, bottom, left, right)
          position: 'right', // Position du message (top, bottom, left, right)
          backgroundColor: 'green', // Couleur de fond
          stopOnFocus: true // Arrêter la fermeture automatique lors du survol
        }).showToast();
        
        location.reload();
      } else {
        alert('Erreur: ' + response.message);
      }
    },
    error: function(xhr, status, error) {
      console.error(xhr.responseText);  // Affiche l'erreur dans la console
      alert('Erreur: la requête a échoué');
    }
  });
}


// Définir la fonction loadFile
function loadFile(event) {
  var image = document.getElementById('output');
  image.src = URL.createObjectURL(event.target.files[0]);
}

$('.new_Btn').click(function () {
  $('#imageid-btn').click();
})

document.addEventListener('DOMContentLoaded', function() {
  // Votre code JavaScript ici, y compris la définition de la fonction loadFile
});

function togglePassword(fieldId) {
  var passwordField = document.getElementById(fieldId);
  var fieldType = passwordField.type;
  passwordField.type = (fieldType === 'password') ? 'text' : 'password';
}

</script>

{% endblock javascripts %}