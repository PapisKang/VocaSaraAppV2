{% extends 'layouts/base.html' %}

{% block title %} Users Reports {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block body_class %} g-sidenav-show bg-gray-100 {% endblock %}

{% block content %}

    <div class="container-fluid py-4">

      <div class="row my-4">
        <div class="col-12">
          <div class="card">
            <div class="table-responsive">
              <div class="dt-responsive table-responsive">
                <table id="user-list-table" class="table nowrap">
                    <thead>
                        <tr>
                            <th>Utilisateur</th>
                            <th>Service</th>
                            <th>Téléphone</th>
                            <th>Date d'inscription</th>
                            <th>Dernière Connexion</th>
                            <th>Statut</th>
                            <th>Rôle Actuel</th>
                            <th>Action</th>

                            
                        </tr>
                    </thead>
                    <tbody>
                        
                        {% for user in context['users'] %}
                      
                        <tr id="tr_{{user.id}}">
                            <td>
                                <div class="d-inline-block align-middle">

                                    <img src="data:image/png;base64,{{ user.image }}" alt="user image" class="img-radius align-top m-r-15" style="width:40px;">

                                    <div class="d-inline-block">
                                        <h6 class="m-b-0"> 
                                            {{user.email}}
                                        </h6>
                                        <p class="m-b-0">
                                            {% if user.full_name %}
                                                {{user.full_name}}
                                            {% endif %}  
                                        </p>
                                    </div>
                                </div>
                            </td> 
                            <td>
                                {% if user.service and user.service|length > 1 %}
                                    <a target="_blank" href="{{user.service}}">{{user.service}}</a>
                                {% else %}
                                    -
                                {% endif %}                                                            
                            </td>
                            <td>
                                {% if user.phone %}
                                    {{user.phone}}
                                {% else %}
                                    -
                                {% endif %}
                            </td>

                            <td>{{user.date_created.strftime('%Y-%m-%d') }}</td>
                            <td>{{ user.last_login_at.strftime('%Y-%m-%d %H:%M:%S') if user.last_login_at else '-' }}</td>
                            <td>
                                <div class="overlay_status" id="overlay_status_update_{{user.id}}">
                                    <div class="cv-spinner">
                                        <span class="spinner"></span>
                                    </div>
                                </div>
                                <div class="form-check form-switch ms-2"> 
                                    <input onchange="statusUpdate({{user.id}})" class="form-check-input statusCheck" type="checkbox" value="{{user.user_id.status}}" {% if user.user_id.status == 1 %}checked {% endif %}>
                                </div>
                            </td>
                            <td>
                            
                                <!-- Add the 'data-toggle' and 'data-placement' attributes for the Bootstrap tooltip -->
                                <button type="button" class="btn btn-info" onclick="changeUserRole({{user.id}}, '{{user.role}}')" data-toggle="tooltip" data-placement="top" title="ADMIN = 1, USER=2">
                                    Change Role
                                </button>
                            </td>
                            <td>
                                <!-- <span class="badge bg-light-success">Active</span> -->
     
                                    <button type="button" class="btn btn-icon btn-danger" onClick="deleteUser({{user.id}})" href="javascript:;"><i
                                            class="fas fa-trash"></i></button>
                                </div>
                            </td>
                            
                        </tr>
                        {% endfor %}

                    </tbody>
                   
                </table>
            </div>
            </div>
          </div>
        </div>
      </div>

<!-- model end -->


      {% include "includes/footer.html" %}
      
    </div>

{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %} 
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="{{ config.ASSETS_ROOT }}/js/plugins/chartjs.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>
  <script>


// for status checked unchecked
function statusUpdate(id){
    $("#overlay_status_update_"+id).fadeOut(400);
    $.ajax({
        url : "{{ url_for('authentication_blueprint.update_status') }}",
        type : 'PUT',
        data : {'user_id':id},
        dataType:'json',
        success : function(data) {
           location.reload()
            
        },
            error : function(request,error)
        {
            alert(JSON.parse(request.responseText)['error']);
            return
            }
        }).done(function () {
                setTimeout(function () {
                    $("#overlay_status_update_"+id).fadeOut(500);
            }, 400);
    })
}
function changeUserRole(userId, currentRole) {
    // Make an AJAX request to the server to update the user role
    $.ajax({
        type: "PUT",
        url: "/update_role",
        data: { user_id: userId, current_role: currentRole },
        success: function (response) {
            // Handle success response
            console.log(response);

            // Update the button text with the new role
            $('#currentRole_' + userId).text(response.new_role);

            // Show a SweetAlert success message
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'User role changed to ' + response.new_role,
            });
        },
        error: function (error) {
            // Handle error response
            console.error(error);

            // Show a SweetAlert error message
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: 'Failed to change user role. Please try again.',
            });
        }
    });
}


$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();
});

// Delete Django Ajax Call swal
function deleteUser(id) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
        }).then((result) => {

        if (result.isConfirmed) {
            $.ajax({
                type: "DELETE",
                url: "{{ url_for('authentication_blueprint.delete_user') }}",
                data: { 'user_id': id },
                dataType: 'json',
                success: function (res) {
                    Swal.fire( {icon: 'success',text: res['message']}).then(() => {
                    location.reload();
                });
                }
            });
        
    }
    })
}
</script>
  
{% endblock javascripts %}
